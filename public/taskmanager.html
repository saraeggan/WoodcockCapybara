<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css">
    <title>Taskmanager</title>
</head>
<h1> Taskmanager</h1>

<body>

    <div class="container">

        <h2>List title: </h2><input id="inpTitle" type="text" />
        <button id="dltTaskList">Delete task</button>
        <br> <br>
        <input id="inpTask" type="text" />
        <button id="btnAddTask">Add task</button>
        Share: <input id="share" type="checkbox" />
        <div class="taskManager" id="taskContainer">
        </div>
        <hr>

        <h1>My lists</h1>
        <div id="Mylists">
        </div>
    </div>

    <script>

        let myList = document.getElementById('Mylists');

        async function viewMyLists() {
            const url = "/myLists";

            let credentials = "Bearer " + sessionStorage.getItem("token");

            const headers = {
                "content-type": "application/json",
                "authorization": credentials
            }

            const cfg = {
                method: "GET",
                headers: headers
            }

            let response = await fetch(url, cfg);
            let data = await response.json();
            console.log(data);

            //Lage liste med navn

            let nameList = [];

            for (let item of data) {
                if (!nameList.includes(item.listName)) {
                    nameList.push(item.listName);
                }

            }
            for (let i = 0; i < nameList.length; i++) {
                let divForList = document.createElement("div");
                divForList.classList.add("divForList");
                myList.appendChild(divForList);
                divForList.innerHTML =
                    `<h3 class="ListName">${nameList[i]}</h3>`;
                for (let item of data) {
                    if (item.listName === nameList[i]) {
                        let babyname = document.createElement("div");
                        babyname.classList.add("babyname");
                        divForList.appendChild(babyname);
                        babyname.innerHTML = item.listItem;
                        //Lage en deletbutton
                        deleteButton = document.createElement("button");
                        deleteButton.innerHTML = "Delete";
                        deleteButton.classList.add("dltBtn");
                        babyname.appendChild(deleteButton);

                        //eventlistner for remove button

                        deleteButton.addEventListener('click', async function (evt) {
                            divForList.removeChild(babyname);

                            const url = "/deleteItem";

                            const body = {
                                listName: item.listName,
                                listItem: item.listItem,
                                share: item.share,
                                id: item.id
                            };

                            let credentials = "Bearer " + sessionStorage.getItem("token");

                            const headers = {
                                "content-type": "application/json",
                                "authorization": credentials
                            }

                            const cfg = {
                                method: "DELETE",
                                body: JSON.stringify(body),
                                headers: headers
                            }

                            let response = await fetch(url, cfg);

                            console.log(response);

                            myList.innerHTML = "";

                            viewMyLists();

                        });

                    }
                }


            }
            console.log(nameList);

        }

        viewMyLists();



        /***********************************************************************************/

        let inpTask = document.getElementById('inpTask');
        let btnAddTask = document.getElementById('btnAddTask');
        let taskContainer = document.getElementById('taskContainer');
        let inpTitle = document.getElementById('inpTitle');
        let shareBox = document.getElementById('share');
        let dtlTaskList = document.getElementById('dltTaskList');
        let deleteButton = null;
        let items = [];
        let item = {
            id: null,
            name: null
        };

      

        btnAddTask.addEventListener('click', async function (evt) {
            let taskListItem = document.createElement("li");
            taskListItem.innerHTML = inpTask.value;
            item.name = inpTask.value;


            //ikke lage liste element viss det ikke er tekst i input
            if (inpTask.value === "") {
                alert("You must write something")
            } else {
                taskContainer.appendChild(taskListItem);
            }

            taskListItem.addEventListener('click', function (evt) {
                taskListItem.style.textDecoration = "line-through";


            });


            taskListItem.addEventListener('dblclick', function (evt) {
                taskListItem.style.textDecoration = "none";

            });


            //Lage en deletbutton
            deleteButton = document.createElement("button");
            deleteButton.innerHTML = "Delete";
            deleteButton.classList.add("dltBtn");
            taskListItem.appendChild(deleteButton);


            const url = "/addItem";

            let share = 0;

            if (shareBox.checked) {
                share = 1;
            }

            const body = {
                listName: inpTitle.value,
                listItem: inpTask.value,
                share: share
            };

            //eventlistner for remove button

            deleteButton.addEventListener('click', async function (evt) {
                taskContainer.removeChild(taskListItem);

                const url = "/deleteItem";

                const body = {
                    listName: inpTitle.value,
                    listItem: inpTask.value,
                    share: share,
                    id: id
                };

                console.log(id);

                let credentials = "Bearer " + sessionStorage.getItem("token");

                const headers = {
                    "content-type": "application/json",
                    "authorization": credentials
                }

                const cfg = {
                    method: "DELETE",
                    body: JSON.stringify(body),
                    headers: headers
                }

                let response = await fetch(url, cfg);

                console.log(response);






            });

            //Fjerner input verdi
            //inpTask.value = "";


            let credentials = "Bearer " + sessionStorage.getItem("token");

            const headers = {
                "content-type": "application/json",
                "authorization": credentials
            }

            const cfg = {
                method: "POST",
                body: JSON.stringify(body),
                headers: headers
            }

            let response = await fetch(url, cfg);
            let id = await response.json();
            item.id = id;
            items.push(item);
            console.log(id);

            myList.innerHTML = "";
            viewMyLists();


        });

        function getItems() {

        }

    </script>
</body>

</html>